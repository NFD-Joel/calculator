<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<title>NFD Printing Calculator</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1db954">

<style>
/* Ensure inputs fit inside containers */
* {
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #111;
    color: white;
}

header {
    background: #1db954;
    padding: 20px 10px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
}

.sub {
    font-size: 13px;
    opacity: 0.8;
    margin-top: 4px;
}

.container {
    padding: 15px;
}

.card {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto 20px;
    width: 100%;
    max-width: 500px;
}

label {
    font-size: 14px;
    display: block;
    margin-top: 10px;
    opacity: 0.8;
}

input {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: none;
    background: #2e2e2e;
    color: white;
    font-size: 16px;
    margin-top: 5px;
}

input:focus {
    outline: 2px solid #1db954;
}

.result {
    background: #1e1e1e;
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
}

.final-box {
    position: sticky;
    bottom: 0;
    background: #1db954;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
}

.small {
    font-size: 13px;
    opacity: 0.7;
}

.export-button {
    width: 100%;
    padding: 14px;
    margin-top: 15px;
    border-radius: 10px;
    border: none;
    background: #1db954;
    color: white;
    font-size: 16px;
    cursor: pointer;
}

.export-button:hover {
    background: #16a34a;
}

</style>
</head>

<body>

<header>
    NFD Printing
    <div class="sub">3D Print Price Calculator</div>
</header>

<div class="container">

<div class="card">
<label>Client Name</label>
<input type="text" id="clientName" placeholder="Optional">

<label>Project Name</label>
<input type="text" id="projectName" placeholder="Optional">

<label>Material price per kg (Gs)</label>
<input type="number" id="materialPrice" value="200000">

<label>Shipping per kg (Gs)</label>
<input type="number" id="shipping" value="10000">

<label>Weight per piece (g)</label>
<input type="number" id="weight" value="7.5">

<label>Quantity</label>
<input type="number" id="quantity" value="1">

<label>Print hours (total job)</label>
<input type="number" id="hours" value="1">

<label>Machine cost per hour (Gs)</label>
<input type="number" id="machineCost" value="2500">

<label>Labor per job (Gs)</label>
<input type="number" id="labor" value="15000">

<label>Profit margin (0.30 = 30%)</label>
<input type="number" step="0.01" id="profitMargin" value="0.30">

<label>IVA (0.10 = 10%)</label>
<input type="number" step="0.01" id="iva" value="0.10">

<label>Minimum final price (Gs)</label>
<input type="number" id="minimum" value="40000">

<button class="export-button" onclick="generateOfferPDF()">Export Offer PDF</button>
<button class="export-button" onclick="generateInvoicePDF()">Generate Invoice PDF</button>
</div>

<div class="card result" id="breakdown"></div>

</div>

<div class="final-box" id="finalPrice">
FINAL PRICE: -
</div>

<script>
function formatGs(value) {
    return value.toLocaleString("en-US") + " Gs";
}

function calculate() {
    let materialPrice = parseFloat(materialPriceInput.value) || 0;
    let shipping = parseFloat(shippingInput.value) || 0;
    let weight = parseFloat(weightInput.value) || 0;
    let quantity = parseFloat(quantityInput.value) || 0;
    let hours = parseFloat(hoursInput.value) || 0;
    let machineCost = parseFloat(machineCostInput.value) || 0;
    let labor = parseFloat(laborInput.value) || 0;
    let profitMargin = parseFloat(profitMarginInput.value) || 0;
    let iva = parseFloat(ivaInput.value) || 0;
    let minimum = parseFloat(minimumInput.value) || 0;

    let adjustedKg = materialPrice + shipping;
    let materialCost = (adjustedKg / 1000) * weight * quantity;
    let machine = hours * machineCost;
    let baseCost = materialCost + machine + labor;
    let profit = baseCost * profitMargin;

    let discountPercent = 0;
    if (quantity == 1) discountPercent = 0;
    else if (quantity <= 3) discountPercent = 0.10;
    else if (quantity <= 6) discountPercent = 0.20;
    else discountPercent = 0.30;

    let discount = (labor + profit) * discountPercent;
    let net = baseCost + profit - discount;
    let ivaAmount = net * iva;
    let finalPrice = net + ivaAmount;

    if (finalPrice < minimum) finalPrice = minimum;

    breakdown.innerHTML = `
        <div class="small">Material: ${formatGs(materialCost)}</div>
        <div class="small">Machine: ${formatGs(machine)}</div>
        <div class="small">Labor: ${formatGs(labor)}</div>
        <div class="small">Profit: ${formatGs(profit)}</div>
        <div class="small">Discount (${discountPercent*100}%): -${formatGs(discount)}</div>
        <div class="small">IVA: ${formatGs(ivaAmount)}</div>
    `;

    finalPriceDiv.innerHTML = "FINAL PRICE: " + formatGs(Math.round(finalPrice));
}

function generateOfferPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    // Logo
    const img = new Image();
    img.src = './images/logo.png';
    img.onload = function() {
        pdf.addImage(img, 'PNG', 10, 10, 50, 25); // 50mm width, height auto

        // Header
        pdf.setFontSize(16);
        pdf.text("Offer for: " + (clientNameInput.value || "Client"), 70, 20);
        if(projectNameInput.value) pdf.text("Project: " + projectNameInput.value, 70, 30);

        // Price breakdown
        pdf.setFontSize(12);
        let y = 50;
        pdf.text(`Material: ${formatGs(parseFloat(materialPriceInput.value))}`, 10, y);
        y += 10;
        pdf.text(`Machine: ${formatGs(parseFloat(hoursInput.value) * parseFloat(machineCostInput.value))}`, 10, y);
        y += 10;
        pdf.text(`Labor: ${formatGs(parseFloat(laborInput.value))}`, 10, y);
        y += 10;
        pdf.text(`Profit: ${formatGs(parseFloat(profitMarginInput.value) * (parseFloat(materialPriceInput.value) + parseFloat(hoursInput.value) * parseFloat(machineCostInput.value) + parseFloat(laborInput.value)))}`, 10, y);
        y += 10;
        pdf.text(finalPriceDiv.innerText, 10, y);

        // Save PDF
        let filename = clientNameInput.value ? clientNameInput.value : "Offer";
        pdf.save(`${filename}.pdf`);
    };
}

function generateInvoicePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    // Logo
    const img = new Image();
    img.src = './images/logo.png';
    img.onload = function() {
        pdf.addImage(img, 'PNG', 10, 10, 50, 25);

        // Header
        pdf.setFontSize(16);
        pdf.text("Invoice", 70, 20);
        pdf.setFontSize(12);
        pdf.text("Client: " + (clientNameInput.value || "Client"), 70, 30);
        if(projectNameInput.value) pdf.text("Project: " + projectNameInput.value, 70, 40);

        // Invoice metadata
        let invoiceNumber = "INV-" + new Date().getTime(); // simple unique ID
        let issueDate = new Date().toLocaleDateString();
        let dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 15); // 15 days later
        dueDate = dueDate.toLocaleDateString();

        pdf.text("Invoice #: " + invoiceNumber, 10, 60);
        pdf.text("Issue Date: " + issueDate, 10, 70);
        pdf.text("Due Date: " + dueDate, 10, 80);

        // Price info (reuse your final price)
        pdf.text(finalPriceDiv.innerText, 10, 100);

        // Optional: payment instructions
        pdf.text("Payment via bank transfer to account XXXXXXXX", 10, 120);

        // Save PDF
        let filename = clientNameInput.value ? `Invoice_${clientNameInput.value}.pdf` : "Invoice.pdf";
        pdf.save(filename);
    };
}


const clientNameInput = document.getElementById("clientName");
const projectNameInput = document.getElementById("projectName");
const materialPriceInput = document.getElementById("materialPrice");
const shippingInput = document.getElementById("shipping");
const weightInput = document.getElementById("weight");
const quantityInput = document.getElementById("quantity");
const hoursInput = document.getElementById("hours");
const machineCostInput = document.getElementById("machineCost");
const laborInput = document.getElementById("labor");
const profitMarginInput = document.getElementById("profitMargin");
const ivaInput = document.getElementById("iva");
const minimumInput = document.getElementById("minimum");
const breakdown = document.getElementById("breakdown");
const finalPriceDiv = document.getElementById("finalPrice");

document.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", calculate);
});

calculate();

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
